{% extends "base.html" %}

{% block title %}User Registration - Myndwell Admin{% endblock %}
{% block page_title %}User Registration{% endblock %}

{% block content %}
<div class="registration-page">
    <!-- Tab Navigation -->
    <div class="card mb-4">
        <div class="card-body">
            <ul class="nav nav-tabs" id="registrationTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="single-tab" data-bs-toggle="tab" data-bs-target="#single-registration" 
                            type="button" role="tab">
                        <i class="bi bi-person-plus me-2"></i>Single Registration
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="bulk-tab" data-bs-toggle="tab" data-bs-target="#bulk-registration" 
                            type="button" role="tab">
                        <i class="bi bi-people-fill me-2"></i>Bulk Registration
                    </button>
                </li>
            </ul>
        </div>
    </div>

    <div class="tab-content" id="registrationTabContent">
        <!-- Single Registration Tab -->
        <div class="tab-pane fade show active" id="single-registration" role="tabpanel">
            <div class="row justify-content-center">
                <div class="col-lg-8">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-person-plus me-2"></i>Register New User
                            </h5>
                        </div>
                        <div class="card-body">
                            <form id="singleRegistrationForm" class="needs-validation" novalidate>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="fullName" class="form-label">
                                            Full Name <span class="text-danger">*</span>
                                        </label>
                                        <input type="text" class="form-control" id="fullName" name="fullName" required>
                                        <div class="invalid-feedback">Please provide a valid name.</div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="email" class="form-label">
                                            Primary Email <span class="text-danger">*</span>
                                        </label>
                                        <input type="email" class="form-control" id="email" name="email" required>
                                        <div class="invalid-feedback">Please provide a valid email address.</div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="company" class="form-label">
                                            Company <span class="text-danger">*</span>
                                        </label>
                                        <select class="form-select" id="company" name="company" required>
                                            <option value="">Select Company</option>
                                            {% for company in companies %}
                                            <option value="{{ company.id }}">{{ company.name }}</option>
                                            {% endfor %}
                                        </select>
                                        <div class="invalid-feedback">Please select a company.</div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="mobile" class="form-label">Mobile Number</label>
                                        <input type="tel" class="form-control" id="mobile" name="mobile" maxlength="10">
                                        <div class="invalid-feedback" id="mobile-error">Please enter a valid 10-digit mobile number.</div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="yearOfBirth" class="form-label">Year of Birth</label>
                                        <select class="form-select" id="yearOfBirth" name="yearOfBirth">
                                            <option value="">Select Year</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="altEmail" class="form-label">Alternate Email</label>
                                        <input type="email" class="form-control" id="altEmail" name="altEmail">
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="designation" class="form-label">Designation</label>
                                        <select class="form-select" id="designation" name="designation">
                                            <option value="">Select Designation</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="department" class="form-label">Department</label>
                                        <select class="form-select" id="department" name="department">
                                            <option value="">Select Department</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="location" class="form-label">Location</label>
                                        <select class="form-select" id="location" name="location">
                                            <option value="">Select Location</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="currentRole" class="form-label">Current Role</label>
                                        <select class="form-select" id="currentRole" name="currentRole">
                                            <option value="">Select Role</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <label for="workmode" class="form-label">Work Mode</label>
                                        <select class="form-select" id="workmode" name="workmode">
                                            <option value="">Select Work Mode</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="shift" class="form-label">Shift</label>
                                        <select class="form-select" id="shift" name="shift">
                                            <option value="">Select Shift</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="maritalStatus" class="form-label">Marital Status</label>
                                        <select class="form-select" id="maritalStatus" name="maritalStatus">
                                            <option value="">Select Status</option>
                                            <option value="Single">Single</option>
                                            <option value="Married">Married</option>
                                            <option value="Divorced">Divorced</option>
                                            <option value="Widowed">Widowed</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="yearOfJoining" class="form-label">Year of Joining</label>
                                        <select class="form-select" id="yearOfJoining" name="yearOfJoining">
                                            <option value="">Select Year</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="d-flex justify-content-end gap-2">
                                    <button type="reset" class="btn btn-outline-secondary">Reset</button>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-person-plus me-2"></i>Register User
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bulk Registration Tab -->
        <div class="tab-pane fade" id="bulk-registration" role="tabpanel">
            <div class="row justify-content-center">
                <div class="col-lg-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-upload me-2"></i>Bulk User Registration
                            </h5>
                        </div>
                        <div class="card-body text-center">
                            <form id="bulkRegistrationForm">
                                <div class="upload-area mb-4">
                                    <i class="bi bi-file-earmark-excel display-4 text-muted mb-3"></i>
                                    <h6>Upload Excel File</h6>
                                    <p class="text-muted">Select an Excel file (.xls, .xlsx) containing user data</p>
                                    
                                    <div class="mb-3">
                                        <input type="file" class="form-control" id="xlsFile" name="xlsFile" 
                                               accept=".xls,.xlsx" required>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <a href="#" class="text-decoration-none">
                                            <i class="bi bi-download me-1"></i>Download Template
                                        </a>
                                    </div>
                                </div>

                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-upload me-2"></i>Upload Users
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Populate year dropdowns
document.addEventListener('DOMContentLoaded', function() {
    const currentYear = new Date().getFullYear();
    
    // Year of Birth dropdown
    const yearOfBirthSelect = document.getElementById('yearOfBirth');
    for (let year = currentYear; year >= currentYear - 150; year--) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        yearOfBirthSelect.appendChild(option);
    }
    
    // Year of Joining dropdown
    const yearOfJoiningSelect = document.getElementById('yearOfJoining');
    for (let year = currentYear; year >= currentYear - 60; year--) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        yearOfJoiningSelect.appendChild(option);
    }
});

// Mobile number validation
document.getElementById('mobile').addEventListener('input', function(event) {
    const mobileInput = event.target;
    const errorDiv = document.getElementById('mobile-error');
    
    // Remove non-digit characters
    mobileInput.value = mobileInput.value.replace(/\D/g, '');
    
    if (mobileInput.value === "") {
        mobileInput.classList.remove('is-invalid');
        return;
    }
    
    if (mobileInput.value.length > 0 && mobileInput.value.length < 10) {
        mobileInput.classList.add('is-invalid');
        errorDiv.style.display = 'block';
    } else {
        mobileInput.classList.remove('is-invalid');
        errorDiv.style.display = 'none';
    }
});

// Email field validation
const emailFields = document.querySelectorAll('#email, #altEmail');
emailFields.forEach(field => {
    field.addEventListener('input', function(event) {
        const input = event.target;
        input.value = input.value.trim().replace(/\s/g, '');
    });
});

// Company change handler
document.getElementById('company').addEventListener('change', async function() {
    const companyId = this.value;
    
    // Clear dependent dropdowns
    const dropdowns = ['designation', 'department', 'location', 'currentRole', 'workmode', 'shift'];
    dropdowns.forEach(id => {
        const select = document.getElementById(id);
        select.innerHTML = '<option value="">Select ' + id.charAt(0).toUpperCase() + id.slice(1) + '</option>';
    });
    
    if (!companyId) return;
    
    try {
        const response = await fetch(`/get-designations-departments-locations/${companyId}`);
        const data = await response.json();
        
        if (response.ok) {
            // Populate dropdowns
            if (data.Designations) {
                const designationSelect = document.getElementById('designation');
                data.Designations.forEach(designation => {
                    const option = document.createElement('option');
                    option.value = designation;
                    option.textContent = designation;
                    designationSelect.appendChild(option);
                });
            }
            
            if (data.Departments) {
                const departmentSelect = document.getElementById('department');
                data.Departments.forEach(department => {
                    const option = document.createElement('option');
                    option.value = department;
                    option.textContent = department;
                    departmentSelect.appendChild(option);
                });
            }
            
            if (data.CompanyLocations) {
                const locationSelect = document.getElementById('location');
                data.CompanyLocations.forEach(location => {
                    const option = document.createElement('option');
                    option.value = location;
                    option.textContent = location;
                    locationSelect.appendChild(option);
                });
            }
            
            if (data.CurrentRoles) {
                const roleSelect = document.getElementById('currentRole');
                data.CurrentRoles.forEach(role => {
                    const option = document.createElement('option');
                    option.value = role;
                    option.textContent = role;
                    roleSelect.appendChild(option);
                });
            }
            
            if (data.WorkMode) {
                const workmodeSelect = document.getElementById('workmode');
                data.WorkMode.forEach(mode => {
                    const option = document.createElement('option');
                    option.value = mode;
                    option.textContent = mode;
                    workmodeSelect.appendChild(option);
                });
            }
            
            if (data.Shift) {
                const shiftSelect = document.getElementById('shift');
                data.Shift.forEach(shift => {
                    const option = document.createElement('option');
                    option.value = shift;
                    option.textContent = shift;
                    shiftSelect.appendChild(option);
                });
            }
        }
    } catch (error) {
        console.error('Error fetching company details:', error);
        showNotification('Error loading company details', 'danger');
    }
});

// Single registration form submission
document.getElementById('singleRegistrationForm').addEventListener('submit', async function(event) {
    event.preventDefault();
    
    const form = event.target;
    if (!form.checkValidity()) {
        event.stopPropagation();
        form.classList.add('was-validated');
        return;
    }
    
    const mobile = document.getElementById('mobile').value;
    const sanitizedMobile = mobile.replace(/\D/g, '');
    
    if (sanitizedMobile.length > 0 && sanitizedMobile.length < 10) {
        document.getElementById('mobile').classList.add('is-invalid');
        return;
    }
    
    const formData = new FormData(form);
    const data = {
        fullName: formData.get('fullName'),
        yearOfBirth: formData.get('yearOfBirth'),
        mobile: sanitizedMobile || null,
        email: formData.get('email').toLowerCase(),
        altEmail: formData.get('altEmail')?.toLowerCase() || null,
        company_id: formData.get('company'),
        designation: formData.get('designation'),
        currentRole: document.getElementById('currentRole').selectedOptions[0]?.text || '',
        maritalStatus: formData.get('maritalStatus'),
        department: formData.get('department'),
        location: formData.get('location'),
        yearOfJoining: formData.get('yearOfJoining'),
        workMode: formData.get('workmode'),
        shift: formData.get('shift')
    };
    
    try {
        const response = await fetch('/register-user', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showNotification('User registered successfully!', 'success');
            form.reset();
            form.classList.remove('was-validated');
        } else {
            showNotification('Error: ' + result.error, 'danger');
        }
    } catch (error) {
        console.error('Error registering user:', error);
        showNotification('Error registering user', 'danger');
    }
});

// Bulk registration form submission
document.getElementById('bulkRegistrationForm').addEventListener('submit', async function(event) {
    event.preventDefault();
    
    const fileInput = document.getElementById('xlsFile');
    if (!fileInput.files[0]) {
        showNotification('Please select a file', 'warning');
        return;
    }
    
    const formData = new FormData();
    formData.append('xlsFile', fileInput.files[0]);
    
    try {
        const response = await fetch('/register-users', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showNotification(`Users registered successfully! Count: ${result.count}`, 'success');
            fileInput.value = '';
        } else {
            showNotification('Error: ' + result.error, 'danger');
        }
    } catch (error) {
        console.error('Error registering users:', error);
        showNotification('Error registering users', 'danger');
    }
});
</script>
{% endblock %}